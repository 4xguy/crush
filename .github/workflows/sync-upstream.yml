name: Sync Upstream

on:
  schedule:
    - cron: "0 9 * * 1-5" # Weekdays at 09:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: git remote add upstream https://github.com/charmbracelet/crush.git

      - name: Fast-forward main from upstream
        run: |
          git fetch upstream main
          git checkout main
          BEFORE=$(git rev-parse HEAD)
          git merge --ff-only upstream/main
          AFTER=$(git rev-parse HEAD)
          if [ "$BEFORE" != "$AFTER" ]; then
            git push origin main
            echo "UPDATED_MAIN=1" >> "$GITHUB_ENV"
          else
            echo "UPDATED_MAIN=0" >> "$GITHUB_ENV"
          fi

      - name: Ensure custom/main exists
        id: has_custom
        run: |
          if git ls-remote --exit-code origin custom/main >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open PR from main -> custom/main with upstream changes
        if: steps.has_custom.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git fetch origin custom/main
          BASE_HASH=$(git rev-parse origin/custom/main)
          HEAD_HASH=$(git rev-parse main)
          if [ "$BASE_HASH" = "$HEAD_HASH" ]; then
            echo "custom/main already up to date; skipping PR."
            exit 0
          fi
          EXISTING=$(gh pr list --state open --base custom/main --head main --json number --jq 'length')
          if [ "$EXISTING" != "0" ]; then
            echo "PR already open; nothing to do."
            exit 0
          fi
          gh pr create \
            --base custom/main \
            --head main \
            --title "chore: sync upstream into custom/main" \
            --body "Automated sync: bring upstream main into custom/main. Generated by sync-upstream workflow."
